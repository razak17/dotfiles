#!/bin/sh
scversion="stable" # or "v0.4.7", or "latest"
lsp_path='.cache/nvim/nvim_lsp'
neovim_py='.cache/nvim/venv/neovim'
dap_py='.cache/nvim/venv/dap'
dap_dir='.cache/nvim/dap'

dirs=(
  '.cache/backup'
  '.cache/session'
  '.cache/swap'
  '.cache/tags'
  '.cache/undodir'
  '.cache/nvim_lsp'
  '.cache/dap'
)

simple_lsp=(
  "vscode-json-languageserver",
  "vscode-css-languageserver-bin",
  "dockerfile-language-server-nodejs",
  "graphql-language-service-cli",
  "vscode-html-languageserver-bin",
  "svelte-language-server",
  "vim-language-server",
  "yaml-language-server",
  "bash-language-server",
  "sql-language-server",
  'typescript-language-server',
  'typescript',
  'pyright'
  'neovim'

)

createDirs() {
  for d in ${dirs[@]}; do
    echo creating dir: $d
    mkdir -p ~/$d
  done
  mkdir -p ~/$lsp_path
}

pythonVenvInit() {
  mkdir -p ~/$neovim_py
  python3 -m venv ~/$neovim_py
  ~/$neovim_py/bin/pip3 install -U setuptools pynvim jedi isort flake8 black neovim-remote
}

dapVenvInit() {
  mkdir -p ~/$dap_py
  python3 -m venv ~/$dap_py
  ~/$dap_py/bin/python -m pip install debugpy
}

nodeHostInit() {
  for l in ${simple_lsp[@]}; do
    echo installing server: $l
    npm i -g $l
  done
}

golangInit() {
  go get github.com/mattn/efm-langserver
  go get golang.org/x/tools/gopls@latest
  asdf reshim golang
}

installLua() {
  cd ~/$lsp_path
  curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz
  tar -zxf lua-5.3.5.tar.gz
  cd lua-5.3.5
  make linux test
  sudo make install
}

installLuarocks() {
  cd ~/$lsp_path
  wget https://luarocks.org/releases/luarocks-3.3.1.tar.gz
  tar -zxf luarocks-3.3.1.tar.gz
  cd luarocks-3.3.1
  # ./configure --with-lua-include=/usr/local/include
  ./configure --with-lua-include=/usr/include
  make
  sudo make install
}

installSumneko() {
  cd ~/$lsp_path
  git clone https://github.com/sumneko/lua-language-server
  cd lua-language-server
  git submodule update --init --recursive
  cd 3rd/luamake
  ninja -f ninja/linux.ninja
  cd ../..
  ./3rd/luamake/luamake rebuild
}

installElixirLs() {
  cd ~/$lsp_path
  git clone https://github.com/elixir-lsp/elixir-ls
  cd elixir-ls
  mix deps.get
  mix compile
  mix elixir_ls.release -o ./.bin
}

installLuaformat() {
  luarocks install --server=https://luarocks.org/dev luaformatter
}

installShellcheck() {
  cd ~/$lsp_path
  wget -qO- "https://github.com/koalaman/shellcheck/releases/download/${scversion?}/shellcheck-${scversion?}.linux.x86_64.tar.xz" | tar -xJv
  cp "shellcheck-${scversion}/shellcheck" /usr/bin/
  shellcheck --version
}

installNodeDebug2() {
  cd ~/$dap_dir
  if [ ! -d ~/$dap_dir/vscode-node-debug2 ]; then
    git clone https://github.com/microsoft/vscode-node-debug2.git
  fi
  cd vscode-node-debug2
  npm install
  gulp build
}

# createDirs
# pythonVenvInit
# dapVenvInit
# nodeHostInit
# golangInit
# installLua
# installLuarocks
# installSumneko
# installElixirLs
# installLuaformat
# installShellcheck
installNodeDebug2
